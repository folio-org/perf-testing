STACK_NAME = "performance-testing-load-generators"
MONITORING_STACK_NAME = "monitoring-performance-testing"

def createStack(String loadGeneratorsCount, String instanceType, String spotPrice, String reportingInstanceUrl, String targetRegion, String lgMemory){
    sh(script: "aws cloudformation create-stack --stack-name ${STACK_NAME} \
        --region ${targetRegion} \
        --template-body file://${WORKSPACE}/carrier-io/scripts/cloudformation/load_generator.yml \
        --parameters ParameterKey=InstanceType,ParameterValue=${instanceType} \
        ParameterKey=SpotPrice,ParameterValue=${spotPrice} \
        ParameterKey=LoadGeneratorsCount,ParameterValue=${loadGeneratorsCount} \
        ParameterKey=ReportingInstanceHost,ParameterValue=${reportingInstanceUrl} \
        ParameterKey=LoadGeneratorMemory,ParameterValue=${lgMemory}")
    sh(script: "aws cloudformation wait stack-create-complete --stack-name ${STACK_NAME} --region ${targetRegion}")
} 

def populateData(String tenant){
    sh(script: "unzip [TBD - dataset zip]")
    sh(script: "apt-get install uuid-runtime")
    sh(script: "apt-get install -y postgresql postgresql-contrib")
    sh(script: "apt-get install -y jq")
    sh(script: "[TBD]")
}

def deleteStack(String stackName, String targetRegion){
    sh(script: "aws cloudformation delete-stack --stack-name ${stackName} --region ${targetRegion}")
    sh(script: "aws cloudformation wait stack-delete-complete --stack-name ${stackName} --region ${targetRegion}")
}

def executePerformanceTest(String users, String loadGeneratorsCount, String reportingInstanceUrl, String galloperPostProccessingTaskId, String testName, String testType, String rampUp, String duration, String targetUrl, String distribution, String lgMemory, String artifact, String bucket, String tenant){
    def usersCount = Math.round((params.users.toInteger() / params.loadGeneratorsCount.toInteger()).floatValue())
    sh "docker pull getcarrier/control_tower:1.5 && docker run -t --rm \
        -e REDIS_HOST=${reportingInstanceUrl} \
        -e loki_host=http://${reportingInstanceUrl} \
        -e loki_port=3100 \
        -e build_id=build_${JOB_NAME}_${BUILD_ID} \
        -e GALLOPER_WEB_HOOK=http://${reportingInstanceUrl}/task/${galloperPostProccessingTaskId} \
        -e galloper_url=http://${reportingInstanceUrl} \
        -e bucket=${bucket} \
        -e JVM_ARGS='-Xmx${lgMemory}g' \
        -e DURATION=${duration} \
        -e additional_files='{\"tests/InfluxBackendListenerClient-1.1.jar\": \"/jmeter/apache-jmeter-5.0/lib/ext/InfluxBackendListenerClient.jar\"}' \
        -e artifact=${artifact} getcarrier/control_tower:1.5 \
        -c getcarrier/perfmeter:1.5 -e '{\"cmd\": \"-n -t /mnt/jmeter/${testName}.jmx -JDISTRIBUTION=${distribution} -Jtenant=${tenant} -Jtest_name=${testName} -Jtest.type=${testType} -JVUSERS=${usersCount} -JHOSTNAME=${targetUrl} -JRAMP_UP=${rampUp} -JDURATION=${duration} -Jinflux.host=${reportingInstanceUrl} \"}' -r 1 -t perfmeter -q ${loadGeneratorsCount} \
        -n supertestjob"  
}

def sendNotification(String testName, String testType, int users, String reportingInstanceUrl, String emailsList, String galloperTaskIdForNotifications){
    sh(script: """curl -XPOST -H "Content-Type: application/json" -d '{"notification_type": "api","test": "${testName}", "test_type": "${testType}", "users": ${users}, "influx_host": "${reportingInstanceUrl}", "smpt_user": "folio.email.notifications@gmail.com","smpt_password": "dPwbI9CYw5M5bjU6", "user_list": [${emailsList}]}' http://${reportingInstanceUrl}/task/${galloperTaskIdForNotifications}""")
}

node {

    properties([
    /* Only keep the 30 most recent builds. */
        [$class  : 'BuildDiscarderProperty',
        strategy: [$class: 'LogRotator', numToKeepStr: '30']],
        disableConcurrentBuilds(), 
        parameters([
            choice(choices: "baseline\ncapacity\nfix_load\nlongevity", description: "Test type", name: "testType"),
            string(defaultValue: "1", description: "vUsers count for test execution", name: "users"),
            string(defaultValue: "1", description: "Ramp up, s", name: "rampUp"),
            string(defaultValue: "60", description: "Test duration, s", name: "duration"),
            booleanParam(name: 'populateDatabase', defaultValue: false, description: "Repopulate data to database"),
            string(defaultValue: "", description: "Tenant", name: "tenant"),
            string(defaultValue: "1", description: "Quantity of load generators", name: "loadGeneratorsCount"),
            string(defaultValue: "", description: "test name (without the '.jmx' extension", name: "testName"),
            string(defaultValue: "", description: "Name of .zip file with tests", name: "artifact"),
            string(defaultValue: "tests", description: "Galloper bucket with tests artifact", name: "bucket"),
            string(defaultValue: "t3.medium", description: "Instance type for load generator, all instance types with specs could be found here https://aws.amazon.com/ec2/instance-types", name: "instanceType"),
            string(defaultValue: "0.0125", description: "The maximum hourly price to be paid for any Spot Instance launched to fulfill the request. Default is for t3.medium instance type, more information could be found here https://aws.amazon.com/ec2/spot/pricing", name: "spotPrice"),
            string(defaultValue: "3", description: "Ram memory in GB avaliable per load generator", name: "lgMemory"),
            string(defaultValue: "", description: "FOLIO environment (Okapi URI) against which tests will be executed", name: "targetUrl"),
            string(defaultValue: "", description: "Environment where reporting tools are located", name: "reportingInstanceUrl"),
            string(defaultValue: "", description: """Recipients for email notification in format "user1@mail.com","user2@mail.com","user3@mail.com" """, name: "emailsList"),
            string(defaultValue: "4912116f-b22e-470c-b263-81ffbe6ce847", description: "Galloper task id for post processing", name: "galloperPostProccessingTaskId"),
            string(defaultValue: "a6c0ff76-9abb-4021-99c9-78a02152bf1d", description: "Galloper task id for notifications", name: "galloperTaskIdForNotifications"),
            string(defaultValue: "43-57", description: "user flow distribution", name: "distribution"),
            string(defaultValue: "us-east-1", description: "region", name: "targetRegion"),
            string(defaultValue: "", description: "cluster name to monitor", name: "targetCluster")
        ])
    ])
    
	stage("Checkout") {
            deleteDir()
            step([$class: 'WsCleanup'])
            checkout scm
        }
	withCredentials([[$class: 'AmazonWebServicesCredentialsBinding', 
						credentialsId: "jenkins-aws",
						accessKeyVariable: 'AWS_ACCESS_KEY_ID', 
						secretKeyVariable: 'AWS_SECRET_ACCESS_KEY']]) {
		try {
			stage("Populate data to db") {
				if(params.populateDatabase){
					populateData(params.tenant)
				}    
			}
			
			stage("Configure load generators") {
				createStack(params.loadGeneratorsCount, params.instanceType, params.spotPrice, params.reportingInstanceUrl, params.targetRegion, params.lgMemory)
			}    

			stage("Execute tests") {
				executePerformanceTest(params.users, params.loadGeneratorsCount, params.reportingInstanceUrl, params.galloperPostProccessingTaskId, params.testName, params.testType, params.rampUp, params.duration, params.targetUrl, params.distribution, params.lgMemory, params.artifact, params.bucket, params.tenant)
			}

			stage("Send Notification") {
				sendNotification(params.testName, params.testType, params.users.toInteger(), params.reportingInstanceUrl, params.emailsList, params.galloperTaskIdForNotifications)
			}				
		} catch (Exception err){
			println err
		} finally { 
			stage('Shut down load generators and FOLIO environment'){
				deleteStack(STACK_NAME, params.targetRegion)			
		}
	}
}
